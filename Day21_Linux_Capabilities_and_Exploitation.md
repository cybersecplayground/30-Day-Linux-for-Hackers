# Day 21 ‚Äì Linux Capabilities & Exploitation (Beyond SUID)
<img width="1200" height="400" alt="image" src="https://github.com/user-attachments/assets/889f5ffe-e362-4c06-a357-c83ab0bb131b" />

## Objective
Introduce Linux file capabilities, how they differ from SUID/SGID, how attackers may abuse capabilities (e.g., `setcap`), and defensive measures. This lesson is practical and aims to teach safe enumeration, identification, and mitigation strategies.

---

## 1Ô∏è‚É£ What are Linux Capabilities?
Traditional Unix privilege model is binary: root (UID 0) vs non-root. Linux capabilities break up root privileges into discrete capabilities (e.g., `CAP_NET_ADMIN`, `CAP_SYS_ADMIN`, `CAP_SETUID`). They can be granted to **filesystem objects** so that specific privileges are available to processes executing that binary ‚Äî without needing full root UID.

Capabilities are attached to **files** (file capabilities) and **processes** (inherited when executing a file that has them).

Common capability names you‚Äôll see:
- `cap_net_raw` / `CAP_NET_RAW` ‚Äî raw sockets (ping, sniffing)  
- `cap_net_bind_service` ‚Äî bind to ports <1024 without root  
- `cap_sys_admin` ‚Äî broad, powerful (mounting, namespaces, loopback)  
- `cap_setuid` / `CAP_SETUID` ‚Äî change UID (can help escalate)  
- `cap_dac_read_search` ‚Äî bypass file read/search restrictions

---

## 2Ô∏è‚É£ How Capabilities Differ from SUID
- **SUID**: makes an executable run with the file owner's UID (often root). It elevates *all* privileges the root user has ‚Äî blunt and dangerous.
- **Capabilities**: grant *specific* privileges. More granular and (in theory) safer ‚Äî but still dangerous when misapplied.

Example: `ping` historically required SUID root; modern distros often use `cap_net_raw+ep` on `/bin/ping` instead of SUID root.

---

## 3Ô∏è‚É£ Enumerating File Capabilities
Use `getcap` (from libcap) to list file capabilities.

```bash
# Check a specific binary
getcap /usr/bin/ping

# Recursively search the filesystem for files with capabilities
getcap -r / 2>/dev/null | grep -v '^$'
```

Example output:
```
/usr/bin/ping = cap_net_raw+ep
/usr/bin/somebin = cap_sys_admin,cap_dac_read_search+ep
```

`+ep` means the effective and permitted bits are set.

---

## 4Ô∏è‚É£ Viewing Process Capabilities
Once a process runs an executable with capabilities, the process has those capabilities. Inspect `/proc/<PID>/status`:

```bash
# Look for CapEff, CapPrm fields
grep CapEff /proc/$(pgrep ping)/status
```

There are tools (e.g., `capsh`) that can translate capability hex masks into human-readable names.

---

## 5Ô∏è‚É£ Assigning or Removing Capabilities (`setcap`)
**(Use with caution ‚Äî only on test systems.)**

```bash
# Grant net_raw to ping (example; many distros already do this)
sudo setcap cap_net_raw+ep /usr/bin/ping

# Remove all capabilities from a file
sudo setcap -r /usr/bin/ping

# Show current cap settings again
getcap /usr/bin/ping
```

**Note:** Capabilities persist on the file ‚Äî not tied to current processes. A file with capabilities will pass them to future processes executed from that file.

---

## 6Ô∏è‚É£ Attack Scenarios & Abuse Patterns
Capabilities can be abused to escalate privileges or bypass restrictions without SUID. Here are representative attack patterns (for education/testing):

- **cap_net_bind_service** (`+ep`) on a custom binary allows binding to low ports (e.g., 80) without root. An attacker might replace such a binary or use it to host a backdoor that appears ‚Äúlegitimate.‚Äù
- **cap_dac_read_search** allows bypassing file read/search DAC restrictions ‚Äî attackers can read files they otherwise could not.
- **cap_setuid** paired with writable or replacable binaries can be abused to run as other users.
- **cap_sys_admin** is very powerful: mounting filesystems, performing namespace escapes in some contexts, or manipulating loopback devices. If a file with `cap_sys_admin` is writable or can be replaced by an attacker, the impact is severe.
- **Combining capabilities**: a binary with multiple caps (e.g., `cap_dac_read_search,cap_net_admin`) can provide a versatile foothold.

Common real-world pitfalls:
- Administrators copy files from untrusted sources and `setcap` them without auditing.
- Packages installed to non-standard paths get capabilities but are writable by other users (e.g., `/opt/...` owned by a user with write access).
- Forgotten capabilities on developer tools left on production servers.

---

## 7Ô∏è‚É£ Practical Hands-On Tasks (Do in a lab VM)
1. **Find all files with capabilities:**
```bash
getcap -r / 2>/dev/null
```

2. **Inspect a binary with capabilities** (example: `/usr/bin/ping`):
```bash
getcap /usr/bin/ping
ls -l /usr/bin/ping
```
Explain why ping uses `cap_net_raw` instead of SUID root.

3. **Safely remove capabilities on a test binary and observe behavior** (use a disposable VM):
```bash
sudo setcap -r /tmp/testbinary
```

4. **Search for suspicious capabilities in writable paths:**
```bash
getcap -r /opt /tmp /home 2>/dev/null
```

5. **Audit processes that gained capabilities**:
- Run a binary with capability and inspect `/proc/<PID>/status` to see `CapEff`. Use `capsh --decode=` if available.

---

## 8Ô∏è‚É£ Defensive Measures & Hardening
- **Minimize capability usage**: prefer standard, minimal capability sets for services that truly need them.
- **Avoid writable directories with capable binaries**: ensure binaries with capabilities are owned by root and not writable by untrusted users.
- **Use package manager capabilities when possible**: packaged distributions manage capabilities safely; avoid manual `setcap` on production unless audited.
- **File integrity monitoring**: alert on changes to files in `/usr/bin`, `/sbin`, `/opt`, or any directory where capable binaries live.
- **Use Mandatory Access Controls**: AppArmor / SELinux policies can limit the actual operations even if a process has capabilities.
- **Audit regularly**: `getcap -r /` and review for unexpected entries.

---

## 9Ô∏è‚É£ Study & Further Reading
- `man capabilities` / `man setcap` / `man getcap`  
- libcap documentation and examples  
- Search for CVE cases where capabilities were abused (for curiosity & defensive learning).

---

## ‚ö†Ô∏è Safety & Ethics Note
This material is intended for **defensive, educational, and authorized penetration testing** only. Do **not** run capability manipulation or exploit actions on systems you do not own or have explicit permission to test.

---

üì¢ Follow CyberSecPlayground on Telegram for more advanced Linux exploitation and defensive techniques: https://t.me/cybersecplayground
